<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html">

    <!-- Generated with Sphinx 7.4.7 and Furo 2025.12.19 -->
        <title>:material-magnify-expand: Hybrid Search Implementation - rag-toolkit</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=d577e810" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">rag-toolkit</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <span class="sidebar-brand-text">rag-toolkit</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/gmottola00/rag-toolkit/blob/main/docs/examples/hybrid_search.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/gmottola00/rag-toolkit/edit/main/docs/examples/hybrid_search.md" rel="edit" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="material-magnify-expand-hybrid-search-implementation">
<h1>:material-magnify-expand: Hybrid Search Implementation<a class="headerlink" href="#material-magnify-expand-hybrid-search-implementation" title="Link to this heading">¬∂</a></h1>
<p>!!! success ‚ÄúBest of Both Worlds‚Äù
Learn how to combine vector search with keyword search for more accurate and robust retrieval. Hybrid search leverages the strengths of both approaches to improve search quality.</p>
<hr class="docutils" />
<section id="material-help-circle-why-hybrid-search">
<h2>:material-help-circle: Why Hybrid Search?<a class="headerlink" href="#material-help-circle-why-hybrid-search" title="Link to this heading">¬∂</a></h2>
<p>!!! info ‚ÄúComplementary Strengths‚Äù
Vector search and keyword search each have unique advantages.</p>
<p>=== ‚Äúüîç Vector Search‚Äù</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>**Advantages:**

- ‚úÖ Semantic understanding
- ‚úÖ Finds conceptually similar content
- ‚úÖ Handles synonyms and paraphrases

**Limitations:**

- ‚ùå May miss exact keyword matches
- ‚ùå Less effective for proper nouns/codes
</pre></div>
</div>
<p>=== ‚Äúüìù Keyword Search‚Äù</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>**Advantages:**

- ‚úÖ Exact match precision
- ‚úÖ Great for proper nouns, codes, IDs
- ‚úÖ Fast and deterministic

**Limitations:**

- ‚ùå No semantic understanding
- ‚ùå Misses synonyms
</pre></div>
</div>
<p>=== ‚Äú‚ö° Hybrid Search‚Äù</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>**Benefits:**

- ‚úÖ Best of both worlds
- ‚úÖ Semantic + exact matching
- ‚úÖ More robust retrieval
- ‚úÖ Better overall accuracy
</pre></div>
</div>
</section>
<section id="basic-hybrid-search">
<h2>Basic Hybrid Search<a class="headerlink" href="#basic-hybrid-search" title="Link to this heading">¬∂</a></h2>
<section id="simple-implementation">
<h3>Simple Implementation<a class="headerlink" href="#simple-implementation" title="Link to this heading">¬∂</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rag_toolkit.core.vectorstore</span><span class="w"> </span><span class="kn">import</span> <span class="n">MilvusVectorStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rag_toolkit.core.embedding</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbedding</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rag_toolkit.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchResult</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HybridSearcher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple hybrid search combining vector + keyword.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vector_store</span><span class="p">:</span> <span class="n">MilvusVectorStore</span><span class="p">,</span>
        <span class="n">embedding_client</span><span class="p">:</span> <span class="n">OpenAIEmbedding</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>  <span class="c1"># Weight for vector search</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize hybrid searcher.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            vector_store: Vector store for semantic search</span>
<span class="sd">            embedding_client: Embedding client</span>
<span class="sd">            alpha: Weight for vector search (1-alpha for keyword)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">vector_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_client</span> <span class="o">=</span> <span class="n">embedding_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform hybrid search.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            query: Search query</span>
<span class="sd">            limit: Number of results</span>
<span class="sd">            filter: Metadata filter</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Ranked search results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Vector search</span>
        <span class="n">vector_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Get more candidates</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        
        <span class="c1"># 2. Keyword search (BM25 or simple text matching)</span>
        <span class="n">keyword_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyword_search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        
        <span class="c1"># 3. Combine scores</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reciprocal_rank_fusion</span><span class="p">(</span>
            <span class="n">vector_results</span><span class="p">,</span>
            <span class="n">keyword_results</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">60</span>  <span class="c1"># RRF constant</span>
        <span class="p">)</span>
        
        <span class="c1"># 4. Return top K</span>
        <span class="k">return</span> <span class="n">combined</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_keyword_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simple BM25-style keyword search.&quot;&quot;&quot;</span>
        <span class="c1"># Get all documents (in production, use Elasticsearch or similar)</span>
        <span class="n">all_docs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>
        
        <span class="c1"># Score documents</span>
        <span class="n">query_terms</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">scored_docs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">all_docs</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bm25_score</span><span class="p">(</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                <span class="n">query_terms</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">scored_docs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
        
        <span class="c1"># Sort by score</span>
        <span class="n">scored_docs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Convert to SearchResult</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scored_docs</span><span class="p">[:</span><span class="n">limit</span><span class="p">]:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SearchResult</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                    <span class="n">vector</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">vector</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_bm25_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query_terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">k1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplified BM25 scoring.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">query_terms</span><span class="p">:</span>
            <span class="c1"># Term frequency</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            
            <span class="c1"># Document length normalization</span>
            <span class="n">doc_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">avg_doc_len</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Approximate</span>
            
            <span class="c1"># BM25 formula (simplified)</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="n">tf</span> <span class="o">*</span> <span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">tf</span> <span class="o">+</span> <span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">doc_len</span> <span class="o">/</span> <span class="n">avg_doc_len</span><span class="p">)</span>
            
            <span class="n">score</span> <span class="o">+=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
        
        <span class="k">return</span> <span class="n">score</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_reciprocal_rank_fusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vector_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">],</span>
        <span class="n">keyword_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine results using Reciprocal Rank Fusion.</span>
<span class="sd">        </span>
<span class="sd">        RRF formula: score(doc) = sum(1 / (k + rank))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create score map</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Add vector scores (rank-based)</span>
        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vector_results</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Add keyword scores (rank-based)</span>
        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keyword_results</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Sort by combined score</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Convert back to SearchResult</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ranked</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Usage</span>
<span class="n">searcher</span> <span class="o">=</span> <span class="n">HybridSearcher</span><span class="p">(</span>
    <span class="n">vector_store</span><span class="o">=</span><span class="n">vector_store</span><span class="p">,</span>
    <span class="n">embedding_client</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
<span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="n">query</span><span class="o">=</span><span class="s2">&quot;machine learning algorithms&quot;</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-hybrid-search">
<h2>Advanced Hybrid Search<a class="headerlink" href="#advanced-hybrid-search" title="Link to this heading">¬∂</a></h2>
<section id="milvus-native-hybrid-search">
<h3>Milvus Native Hybrid Search<a class="headerlink" href="#milvus-native-hybrid-search" title="Link to this heading">¬∂</a></h3>
<p>Milvus 2.4+ supports native hybrid search with multiple vector fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pymilvus</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">connections</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MilvusHybridSearch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Milvus native hybrid search with sparse + dense vectors.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dense_embedding</span><span class="p">:</span> <span class="n">OpenAIEmbedding</span><span class="p">,</span>
        <span class="n">sparse_embedding</span><span class="p">:</span> <span class="n">SparseEmbedding</span><span class="p">,</span>  <span class="c1"># BM25 or SPLADE</span>
    <span class="p">):</span>
        <span class="n">connections</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s2">&quot;19530&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">collection_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_embedding</span> <span class="o">=</span> <span class="n">dense_embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_embedding</span> <span class="o">=</span> <span class="n">sparse_embedding</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">hybrid_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">dense_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="n">filter_expr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Milvus native hybrid search.&quot;&quot;&quot;</span>
        <span class="c1"># Generate both embeddings</span>
        <span class="n">dense_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_embedding</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">sparse_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_embedding</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="c1"># Hybrid search</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[</span>
                <span class="p">[</span><span class="n">dense_vector</span><span class="p">],</span>  <span class="c1"># Dense search</span>
                <span class="p">[</span><span class="n">sparse_vector</span><span class="p">]</span>  <span class="c1"># Sparse search</span>
            <span class="p">],</span>
            <span class="n">anns_field</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dense_vector&quot;</span><span class="p">,</span> <span class="s2">&quot;sparse_vector&quot;</span><span class="p">],</span>
            <span class="n">param</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;metric_type&quot;</span><span class="p">:</span> <span class="s2">&quot;COSINE&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ef&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">}},</span>
                <span class="p">{</span><span class="s2">&quot;metric_type&quot;</span><span class="p">:</span> <span class="s2">&quot;IP&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="p">],</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">filter_expr</span><span class="p">,</span>
            <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">],</span>
            <span class="n">rerank</span><span class="o">=</span><span class="n">RRFReranker</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">dense_weight</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dense_weight</span><span class="p">])</span>
        <span class="p">)</span>
        
        <span class="c1"># Convert to SearchResult</span>
        <span class="n">search_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
                <span class="n">search_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">SearchResult</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">hit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="n">hit</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">hit</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                        <span class="n">score</span><span class="o">=</span><span class="n">hit</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                        <span class="n">vector</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">search_results</span>
</pre></div>
</div>
</section>
<section id="elasticsearch-milvus-hybrid">
<h3>Elasticsearch + Milvus Hybrid<a class="headerlink" href="#elasticsearch-milvus-hybrid" title="Link to this heading">¬∂</a></h3>
<p>Use Elasticsearch for keyword search and Milvus for vector search:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">elasticsearch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ElasticsearchMilvusHybrid</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hybrid search with Elasticsearch + Milvus.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">es_client</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
        <span class="n">es_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">milvus_store</span><span class="p">:</span> <span class="n">MilvusVectorStore</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">OpenAIEmbedding</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">es</span> <span class="o">=</span> <span class="n">es_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">es_index</span> <span class="o">=</span> <span class="n">es_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">milvus</span> <span class="o">=</span> <span class="n">milvus_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hybrid search with Elasticsearch + Milvus.&quot;&quot;&quot;</span>
        <span class="c1"># 1. Elasticsearch BM25 search</span>
        <span class="n">es_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">es</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">es_index</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
                        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;best_fields&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">}</span>
        <span class="p">)</span>
        
        <span class="c1"># 2. Milvus vector search</span>
        <span class="n">milvus_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">milvus</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span>
        
        <span class="c1"># 3. Combine scores (weighted average)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_fusion</span><span class="p">(</span>
            <span class="n">es_results</span><span class="p">[</span><span class="s1">&#39;hits&#39;</span><span class="p">][</span><span class="s1">&#39;hits&#39;</span><span class="p">],</span>
            <span class="n">milvus_results</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">combined</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_weighted_fusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">es_hits</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">milvus_hits</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">],</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weighted score fusion.&quot;&quot;&quot;</span>
        <span class="c1"># Normalize scores</span>
        <span class="n">es_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">es_hits</span><span class="p">:</span>
            <span class="n">max_es</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;_score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">es_hits</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">es_hits</span><span class="p">:</span>
                <span class="n">es_scores</span><span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hit</span><span class="p">[</span><span class="s1">&#39;_score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_es</span>
        
        <span class="n">milvus_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">milvus_hits</span><span class="p">:</span>
            <span class="n">max_milvus</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">score</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">milvus_hits</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">milvus_hits</span><span class="p">:</span>
                <span class="n">milvus_scores</span><span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">score</span> <span class="o">/</span> <span class="n">max_milvus</span>
        
        <span class="c1"># Combine scores</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">es_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">milvus_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">doc_id</span> <span class="ow">in</span> <span class="n">all_ids</span><span class="p">:</span>
            <span class="n">es_score</span> <span class="o">=</span> <span class="n">es_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">milvus_score</span> <span class="o">=</span> <span class="n">milvus_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            
            <span class="n">combined_score</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">milvus_score</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">es_score</span>
            <span class="n">combined</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_score</span>
        
        <span class="c1"># Sort and return</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Convert to SearchResult (simplified)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">ranked</span><span class="p">:</span>
            <span class="c1"># Find original document</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">milvus_hits</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">doc_id</span><span class="p">),</span>
                <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</section>
</section>
<section id="adaptive-hybrid-search">
<h2>Adaptive Hybrid Search<a class="headerlink" href="#adaptive-hybrid-search" title="Link to this heading">¬∂</a></h2>
<p>Adjust weights based on query type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveHybridSearch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adaptive hybrid search with query-specific weighting.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vector_store</span><span class="p">:</span> <span class="n">MilvusVectorStore</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">OpenAIEmbedding</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">vector_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adaptive hybrid search.&quot;&quot;&quot;</span>
        <span class="c1"># Determine query type</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_alpha</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="c1"># Perform hybrid search with adaptive weight</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="n">HybridSearcher</span><span class="p">(</span>
            <span class="n">vector_store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="p">,</span>
            <span class="n">embedding_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="k">await</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine vector search weight based on query type.&quot;&quot;&quot;</span>
        <span class="c1"># Proper nouns or codes ‚Üí prefer keyword search</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_proper_nouns</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_codes</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.3</span>  <span class="c1"># 30% vector, 70% keyword</span>
        
        <span class="c1"># Short queries ‚Üí prefer keyword search</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.4</span>  <span class="c1"># 40% vector, 60% keyword</span>
        
        <span class="c1"># Questions or conceptual queries ‚Üí prefer vector search</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;what&quot;</span><span class="p">,</span> <span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;why&quot;</span><span class="p">,</span> <span class="s2">&quot;explain&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="mf">0.9</span>  <span class="c1"># 90% vector, 10% keyword</span>
        
        <span class="c1"># Default: balanced</span>
        <span class="k">return</span> <span class="mf">0.7</span>  <span class="c1"># 70% vector, 30% keyword</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_proper_nouns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if query contains proper nouns.&quot;&quot;&quot;</span>
        <span class="c1"># Simple heuristic: capitalized words mid-sentence</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if query contains codes or IDs.&quot;&quot;&quot;</span>
        <span class="c1"># Pattern: numbers, hyphens, underscores</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z0-9]{2,}[-_][A-Z0-9]+&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>

<span class="c1"># Usage</span>
<span class="n">adaptive</span> <span class="o">=</span> <span class="n">AdaptiveHybridSearch</span><span class="p">(</span>
    <span class="n">vector_store</span><span class="o">=</span><span class="n">vector_store</span><span class="p">,</span>
    <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span>
<span class="p">)</span>

<span class="c1"># Conceptual query ‚Üí high vector weight</span>
<span class="n">results1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adaptive</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;What is machine learning?&quot;</span><span class="p">)</span>

<span class="c1"># Proper noun query ‚Üí high keyword weight</span>
<span class="n">results2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adaptive</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;Find documents about PyTorch&quot;</span><span class="p">)</span>

<span class="c1"># Code query ‚Üí high keyword weight</span>
<span class="n">results3</span> <span class="o">=</span> <span class="k">await</span> <span class="n">adaptive</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;error code ERR_123&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="integration-with-rag-pipeline">
<h2>Integration with RAG Pipeline<a class="headerlink" href="#integration-with-rag-pipeline" title="Link to this heading">¬∂</a></h2>
<section id="custom-hybrid-rag">
<h3>Custom Hybrid RAG<a class="headerlink" href="#custom-hybrid-rag" title="Link to this heading">¬∂</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rag_toolkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">RagPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rag_toolkit.infra.llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAILLM</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HybridRagPipeline</span><span class="p">(</span><span class="n">RagPipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG pipeline with hybrid search.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding_client</span><span class="p">:</span> <span class="n">OpenAIEmbedding</span><span class="p">,</span>
        <span class="n">vector_store</span><span class="p">:</span> <span class="n">MilvusVectorStore</span><span class="p">,</span>
        <span class="n">llm_client</span><span class="p">:</span> <span class="n">OpenAILLM</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">embedding_client</span><span class="o">=</span><span class="n">embedding_client</span><span class="p">,</span>
            <span class="n">vector_store</span><span class="o">=</span><span class="n">vector_store</span><span class="p">,</span>
            <span class="n">llm_client</span><span class="o">=</span><span class="n">llm_client</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_searcher</span> <span class="o">=</span> <span class="n">HybridSearcher</span><span class="p">(</span>
            <span class="n">vector_store</span><span class="o">=</span><span class="n">vector_store</span><span class="p">,</span>
            <span class="n">embedding_client</span><span class="o">=</span><span class="n">embedding_client</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">use_hybrid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query with optional hybrid search.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_hybrid</span><span class="p">:</span>
            <span class="c1"># Use hybrid search</span>
            <span class="n">retrieved</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use standard vector search</span>
            <span class="n">retrieved</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
            <span class="p">)</span>
        
        <span class="c1"># Assemble context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">retrieved</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Generate answer</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Answer the question based on the context below.</span>

<span class="s2">Context:</span>
<span class="si">{</span><span class="n">context</span><span class="si">}</span>

<span class="s2">Question: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">Answer:&quot;&quot;&quot;</span>
        
        <span class="n">answer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">answer</span><span class="p">,</span>
            <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="n">retrieved</span><span class="p">,</span>
            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span>
        <span class="p">}</span>

<span class="c1"># Usage</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">HybridRagPipeline</span><span class="p">(</span>
    <span class="n">embedding_client</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
    <span class="n">vector_store</span><span class="o">=</span><span class="n">vector_store</span><span class="p">,</span>
    <span class="n">llm_client</span><span class="o">=</span><span class="n">OpenAILLM</span><span class="p">(),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
<span class="p">)</span>

<span class="c1"># Query with hybrid search</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;What are the key features of Python?&quot;</span><span class="p">,</span>
    <span class="n">use_hybrid</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="query-specific-hybrid-strategies">
<h2>Query-Specific Hybrid Strategies<a class="headerlink" href="#query-specific-hybrid-strategies" title="Link to this heading">¬∂</a></h2>
<section id="multi-strategy-hybrid">
<h3>Multi-Strategy Hybrid<a class="headerlink" href="#multi-strategy-hybrid" title="Link to this heading">¬∂</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MultiStrategyHybrid</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hybrid search with multiple strategies.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vector_store</span><span class="p">:</span> <span class="n">MilvusVectorStore</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">OpenAIEmbedding</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">vector_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Multi-strategy hybrid search.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            query: Search query</span>
<span class="sd">            limit: Number of results</span>
<span class="sd">            strategy: &quot;vector&quot;, &quot;keyword&quot;, &quot;balanced&quot;, &quot;auto&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_strategy</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;vector&quot;</span><span class="p">:</span>
            <span class="c1"># Pure vector search</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;keyword&quot;</span><span class="p">:</span>
            <span class="c1"># Pure keyword search</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyword_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;balanced&quot;</span><span class="p">:</span>
            <span class="c1"># Balanced hybrid</span>
            <span class="n">searcher</span> <span class="o">=</span> <span class="n">HybridSearcher</span><span class="p">(</span>
                <span class="n">vector_store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="p">,</span>
                <span class="n">embedding_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown strategy: </span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-detect best strategy for query.&quot;&quot;&quot;</span>
        <span class="c1"># Question words ‚Üí vector</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;what&quot;</span><span class="p">,</span> <span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;why&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;vector&quot;</span>
        
        <span class="c1"># Exact phrases ‚Üí keyword</span>
        <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;keyword&quot;</span>
        
        <span class="c1"># IDs or codes ‚Üí keyword</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z0-9]{3,}[-_]&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;keyword&quot;</span>
        
        <span class="c1"># Default: balanced</span>
        <span class="k">return</span> <span class="s2">&quot;balanced&quot;</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_keyword_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pure keyword search implementation.&quot;&quot;&quot;</span>
        <span class="c1"># Implementation details...</span>
        <span class="k">pass</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-optimization">
<h2>Performance Optimization<a class="headerlink" href="#performance-optimization" title="Link to this heading">¬∂</a></h2>
<section id="parallel-search">
<h3>Parallel Search<a class="headerlink" href="#parallel-search" title="Link to this heading">¬∂</a></h3>
<p>Execute vector and keyword searches in parallel:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ParallelHybridSearch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hybrid search with parallel execution.&quot;&quot;&quot;</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parallel hybrid search.&quot;&quot;&quot;</span>
        <span class="c1"># Execute searches in parallel</span>
        <span class="n">vector_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">keyword_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyword_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">vector_results</span><span class="p">,</span> <span class="n">keyword_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="n">vector_task</span><span class="p">,</span>
            <span class="n">keyword_task</span>
        <span class="p">)</span>
        
        <span class="c1"># Combine results</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reciprocal_rank_fusion</span><span class="p">(</span>
            <span class="n">vector_results</span><span class="p">,</span>
            <span class="n">keyword_results</span>
        <span class="p">)[:</span><span class="n">limit</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="caching">
<h3>Caching<a class="headerlink" href="#caching" title="Link to this heading">¬∂</a></h3>
<p>Cache hybrid search results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CachedHybridSearch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hybrid search with result caching.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_store</span><span class="p">,</span> <span class="n">embedding</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">vector_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SearchResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cached hybrid search.&quot;&quot;&quot;</span>
        <span class="c1"># Generate cache key</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cache_key</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="c1"># Check cache</span>
        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        
        <span class="c1"># Perform search</span>
        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hybrid_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="c1"># Cache results</span>
        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate cache key.&quot;&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="evaluation">
<h2>Evaluation<a class="headerlink" href="#evaluation" title="Link to this heading">¬∂</a></h2>
<section id="compare-strategies">
<h3>Compare Strategies<a class="headerlink" href="#compare-strategies" title="Link to this heading">¬∂</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_hybrid_search</span><span class="p">(</span>
    <span class="n">queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">searcher</span><span class="p">:</span> <span class="n">HybridSearcher</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate hybrid search performance.&quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;precision@5&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;recall@5&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;mrr&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
        <span class="c1"># Search</span>
        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">retrieved_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        
        <span class="c1"># Ground truth</span>
        <span class="n">relevant_ids</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relevant_ids</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="c1"># Precision@5</span>
        <span class="n">relevant_retrieved</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">retrieved_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">relevant_ids</span><span class="p">)</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_retrieved</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieved_ids</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;precision@5&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
        
        <span class="c1"># Recall@5</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_retrieved</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_ids</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;recall@5&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
        
        <span class="c1"># MRR</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">retrieved_ids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">doc_id</span> <span class="ow">in</span> <span class="n">relevant_ids</span><span class="p">:</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mrr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mrr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    
    <span class="c1"># Average metrics</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

<span class="c1"># Compare strategies</span>
<span class="n">results_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="n">evaluate_hybrid_search</span><span class="p">(</span>
    <span class="n">queries</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> 
    <span class="n">HybridSearcher</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Pure vector</span>
<span class="p">)</span>

<span class="n">results_keyword</span> <span class="o">=</span> <span class="k">await</span> <span class="n">evaluate_hybrid_search</span><span class="p">(</span>
    <span class="n">queries</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span>
    <span class="n">HybridSearcher</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Pure keyword</span>
<span class="p">)</span>

<span class="n">results_hybrid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">evaluate_hybrid_search</span><span class="p">(</span>
    <span class="n">queries</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span>
    <span class="n">HybridSearcher</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># Hybrid</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vector:&quot;</span><span class="p">,</span> <span class="n">results_vector</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keyword:&quot;</span><span class="p">,</span> <span class="n">results_keyword</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hybrid:&quot;</span><span class="p">,</span> <span class="n">results_hybrid</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">¬∂</a></h2>
<ol class="arabic simple">
<li><p><strong>Choose the Right Alpha</strong></p>
<ul class="simple">
<li><p>Start with 0.7 (70% vector, 30% keyword)</p></li>
<li><p>Adjust based on your data and queries</p></li>
<li><p>Use adaptive weighting for different query types</p></li>
</ul>
</li>
<li><p><strong>Optimize Both Search Paths</strong></p>
<ul class="simple">
<li><p>Tune vector index (HNSW, IVF)</p></li>
<li><p>Optimize keyword index (BM25 parameters)</p></li>
<li><p>Consider caching frequently used results</p></li>
</ul>
</li>
<li><p><strong>Use Reciprocal Rank Fusion</strong></p>
<ul class="simple">
<li><p>More robust than weighted averaging</p></li>
<li><p>Less sensitive to score distribution</p></li>
<li><p>Works well with different score ranges</p></li>
</ul>
</li>
<li><p><strong>Test on Real Queries</strong></p>
<ul class="simple">
<li><p>Evaluate on your actual use case</p></li>
<li><p>Compare pure vs. hybrid approaches</p></li>
<li><p>A/B test different alpha values</p></li>
</ul>
</li>
<li><p><strong>Monitor Performance</strong></p>
<ul class="simple">
<li><p>Track search latency</p></li>
<li><p>Measure retrieval quality</p></li>
<li><p>Log query patterns for tuning</p></li>
</ul>
</li>
</ol>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">¬∂</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="advanced_pipeline.html"><span class="std std-doc">Advanced Pipeline</span></a> - Complete RAG pipeline</p></li>
<li><p><a class="reference internal" href="#../user_guide/reranking.md"><span class="xref myst">Reranking Guide</span></a> - Improve ranking quality</p></li>
<li><p><a class="reference internal" href="#../user_guide/vector_stores.md"><span class="xref myst">Vector Stores</span></a> - Vector search deep dive</p></li>
</ul>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading">¬∂</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf">Reciprocal Rank Fusion Paper</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Okapi_BM25">BM25 Algorithm</a></p></li>
<li><p><a class="reference external" href="https://milvus.io/docs/hybrid_search.md">Milvus Hybrid Search</a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, Gianmarco Mottola
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/gmottola00/rag-toolkit" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">:material-magnify-expand: Hybrid Search Implementation</a><ul>
<li><a class="reference internal" href="#material-help-circle-why-hybrid-search">:material-help-circle: Why Hybrid Search?</a></li>
<li><a class="reference internal" href="#basic-hybrid-search">Basic Hybrid Search</a><ul>
<li><a class="reference internal" href="#simple-implementation">Simple Implementation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-hybrid-search">Advanced Hybrid Search</a><ul>
<li><a class="reference internal" href="#milvus-native-hybrid-search">Milvus Native Hybrid Search</a></li>
<li><a class="reference internal" href="#elasticsearch-milvus-hybrid">Elasticsearch + Milvus Hybrid</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adaptive-hybrid-search">Adaptive Hybrid Search</a></li>
<li><a class="reference internal" href="#integration-with-rag-pipeline">Integration with RAG Pipeline</a><ul>
<li><a class="reference internal" href="#custom-hybrid-rag">Custom Hybrid RAG</a></li>
</ul>
</li>
<li><a class="reference internal" href="#query-specific-hybrid-strategies">Query-Specific Hybrid Strategies</a><ul>
<li><a class="reference internal" href="#multi-strategy-hybrid">Multi-Strategy Hybrid</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-optimization">Performance Optimization</a><ul>
<li><a class="reference internal" href="#parallel-search">Parallel Search</a></li>
<li><a class="reference internal" href="#caching">Caching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#evaluation">Evaluation</a><ul>
<li><a class="reference internal" href="#compare-strategies">Compare Strategies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#best-practices">Best Practices</a></li>
<li><a class="reference internal" href="#next-steps">Next Steps</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=38b66d78"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>